<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Performance Gallery</title>
    <style>
        /* Root variables for consistent spacing */
        :root {
            --gap: 20px; /* Define a consistent gap for masonry layout */
        }

        /* Universal box-sizing for easier layout calculations */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body styling for a modern look */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(96deg, #002df8 0%, #ff0000 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Header Styles for the gallery title and description */
        .gallery-header {
            text-align: center;
            padding: 4rem 2rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }

        .gallery-header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .gallery-header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Filter Controls container */
        .filter-controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 0 2rem 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Filter button base style */
        .filter-btn {
            background: transparent;
            color: #ffffff;
            border: 2px solid #ffffff;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Filter button hover effect */
        .filter-btn:hover {
            background-color: #ffffff;
            color: #1e3a8a;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.3);
        }

        /* Active filter button style */
        .filter-btn.active {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: #ffffff;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* Active filter button pseudo-element for subtle animation */
        .filter-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .filter-btn.active:hover::before {
            left: 100%;
        }

        .filter-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        /* Main Gallery Container */
        .portfolio-gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem 4rem; /* Adjusted padding for better fit */
        }

        /* Masonry Grid container */
        .gallery-masonry-grid {
            position: relative; /* Required for Masonry.js absolute positioning */
            width: 100%;
            /* Masonry.js will manage height */
        }

        /* Gallery Item Wrapper - Base styles for each image card */
        .gallery-item-wrapper {
            position: absolute; /* Required for Masonry.js */
            border-radius: 16px;
            overflow: hidden;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            /* Masonry.js will set left/top. Opacity/transform for filtering/hover. */
            opacity: 1; /* Start visible, Masonry handles initial layout */
            transform: translateY(0); /* Start in place */
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* For hover and filter transitions */
            margin-bottom: var(--gap); /* Use gap for bottom margin */
        }

        /* Responsive width for gallery items (columns) */
        /* Default for 4 columns (larger screens) */
        .gallery-item-wrapper {
            width: calc(25% - var(--gap) * 3 / 4); /* 4 columns, 3 gaps */
        }

        /* Hiding animation for filtered out items */
        .gallery-item-wrapper.hiding {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        /* Showing animation for filtered in items */
        .gallery-item-wrapper.showing {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        /* Image Styles within the wrapper */
        .gallery-item-wrapper img {
            width: 100%;
            height: auto;
            display: block;
            transition: all 0.4s ease;
            filter: brightness(1);
        }

        /* Image hover effect */
        .gallery-item-wrapper:hover img {
            filter: brightness(0.7);
        }

        /* Orientation Classes for specific aspect ratios (for CSS control) */
        .landscape img { aspect-ratio: 16/9; object-fit: cover; }
        .portrait img { aspect-ratio: 3/4; object-fit: cover; }
        .square img { aspect-ratio: 1/1; object-fit: cover; }
        .tall-portrait img { aspect-ratio: 2/3; object-fit: cover; }
        .wide-landscape img { aspect-ratio: 21/9; object-fit: cover; }

        /* Overlay Styles for hover effect */
        .gallery-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(102, 126, 234, 0.9) 0%,
                rgba(118, 75, 162, 0.9) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease;
            padding: 2rem;
            text-align: center;
        }

        /* Overlay visibility on hover */
        .gallery-item-wrapper:hover .gallery-item-overlay {
            opacity: 1;
        }

        /* Overlay content animation */
        .overlay-content {
            transform: translateY(20px);
            transition: transform 0.4s ease;
        }

        .gallery-item-wrapper:hover .overlay-content {
            transform: translateY(0);
        }

        /* Overlay text styling */
        .overlay-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .overlay-subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        /* Overlay icon styling */
        .overlay-icon {
            width: 48px;
            height: 48px;
            fill: white;
            filter: drop-shadow(0 2px 10px rgba(0, 0, 0, 0.3));
        }

        /* Loading State indicator */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: white;
            font-size: 1.2rem;
            width: 100%; /* Ensure loading message spans full width */
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* Spin animation for loading indicator */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Back Button Styling */
        .back-button-container {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
        }

        .backbtn {
            background: linear-gradient(135deg, #4CAF50, #2E8B57); /* Green gradient */
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 139, 87, 0.3);
        }

        .backbtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
            background: linear-gradient(135deg, #2E8B57, #4CAF50); /* Inverted gradient on hover */
        }


        /* Responsive Design Media Queries */

        @media (max-width: 1200px) {
            .gallery-item-wrapper {
                width: calc(33.33% - var(--gap) * 2 / 3); /* 3 columns, 2 gaps */
            }
        }

        @media (max-width: 768px) {
            .gallery-header h1 {
                font-size: 2.5rem;
            }

            .gallery-header {
                padding: 2rem 1rem 1rem;
            }

            .gallery-item-wrapper {
                width: calc(50% - var(--gap) / 2); /* 2 columns, 1 gap */
            }

            .portfolio-gallery-container {
                padding: 0 1rem 2rem;
            }

            .filter-controls {
                margin: 0 1rem 2rem;
                padding: 1.5rem;
            }

            .filter-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .gallery-header h1 {
                font-size: 2rem;
            }

            .gallery-item-wrapper {
                width: 100%; /* 1 column */
            }

            .overlay-title {
                font-size: 1.2rem;
            }

            .overlay-subtitle {
                font-size: 0.9rem;
            }

            .gallery-item-overlay {
                padding: 1.5rem;
            }
        }

        /* Performance optimizations (will-change and contain properties) */
        .gallery-item-wrapper {
            will-change: transform, opacity;
            contain: layout style paint;
        }

        .gallery-item-wrapper img {
            will-change: filter, transform;
        }
    </style>
</head>
<body>
    <div class="back-button-container">
        <button class="backbtn">Go Back</button>
    </div>

    <header class="gallery-header">
        <h1>Our Class Moments</h1>
        <p>Capturing our journey through learning, activities, and achievements in the English Access Microscholarship Program.</p>
    </header>

    <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">All Photos</button>
        <button class="filter-btn" data-filter="c-a">Classroom Activities</button>
        <button class="filter-btn" data-filter="s-s">Speaking Sessions</button>
        <button class="filter-btn" data-filter="w-w">Writing Workshops</button>
        <button class="filter-btn" data-filter="g-r">Games & Recreation</button>
        <button class="filter-btn" data-filter="i-d">International Days</button>
        <button class="filter-btn" data-filter="c-p">Creative Projects</button>
        <button class="filter-btn" data-filter="co">Competitions</button>
        <button class="filter-btn" data-filter="s-c">Seminars & Camps</button>
        <button class="filter-btn" data-filter="digital-art">Collaborative Events</button>
    </div>

    <div class="portfolio-gallery-container">
        <div class="gallery-masonry-grid" id="galleryGrid">
            <div class="loading">Loading gallery...</div>
            <!-- Gallery items will be dynamically inserted here by JavaScript -->
        </div>
    </div>

    <!-- REQUIRED: Masonry.js and imagesLoaded.js libraries for proper masonry layout and image handling -->
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>

    <script>
        // Global array to store gallery item data
        let galleryItems = [
            { src: '/assets/gallery-img/CA.jpeg', title: 'First Week of Access', subtitle: 'Class Activity', category: 'c-a' },
            { src: '/assets/gallery-img/CA (2).jpeg', title: 'Group Discussion', subtitle: 'Speaking', category: 'c-a' },
            { src: '/assets/gallery-img/CA (3).jpeg', title: 'Dialogue performance', subtitle: 'Skit', category: 'c-a' },
            { src: '/assets/gallery-img/G.jpeg', title: 'Game', subtitle: 'Pathway', category: 'g-r' },
            { src: '/assets/gallery-img/G (2).jpeg', title: 'Game', subtitle: 'Balloon Race', category: 'g-r' },
            { src: '/assets/gallery-img/ID.jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (2).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (3).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (4).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (5).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (6).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (7).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (8).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (9).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (10).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (11).jpeg', title: 'International Woman Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (12).jpeg', title: 'International No Tobacco Day', subtitle: 'Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (13).jpeg', title: 'International Cultural Day', subtitle: 'Collaborative Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (16).jpeg', title: 'International Cultural Day', subtitle: 'Collaborative Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (17).jpeg', title: 'International Cultural Day', subtitle: 'Collaborative Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (18).jpeg', title: 'International Cultural Day', subtitle: 'Collaborative Event', category: 'i-d' },
            { src: '/assets/gallery-img/ID (15).jpeg', title: 'American Independence Day', subtitle: 'Celebrated', category: 'i-d' },
            { src: '/assets/gallery-img/ID (19).jpeg', title: 'American Independence Day', subtitle: 'Celebrated', category: 'i-d' },
            { src: '/assets/gallery-img/P.jpeg', title: 'Creative Writing', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (2).jpeg', title: 'Creative Writing', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (3).jpeg', title: 'Creative Writing', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (4).jpeg', title: 'Creative Writing', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (5).jpeg', title: 'Poster Making', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (6).jpeg', title: 'Poster Making', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/P (7).jpeg', title: 'Poster Making', subtitle: 'Project', category: 'c-p' },
            { src: '/assets/gallery-img/S.jpeg', title: 'About Yourself', subtitle: 'Speaking', category: 's-s' },
            { src: '/assets/gallery-img/S (2).jpeg', title: 'Group Discussion', subtitle: 'Speaking', category: 's-s' },
            { src: '/assets/gallery-img/S (3).jpeg', title: 'Group Discussion', subtitle: 'Speaking', category: 's-s' },
            { src: '/assets/gallery-img/SC.jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (2).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (3).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (4).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (5).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (6).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (7).jpeg', title: '23rd March & Plantation Day', subtitle: 'Collaborative Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (8).jpeg', title: 'Happy Independence Day', subtitle: 'Celebration', category: 'digital-art' },
            { src: '/assets/gallery-img/SC (9).jpeg', title: 'Online Session', subtitle: 'With Jenna', category: 's-c' },
            { src: '/assets/gallery-img/SC (10).jpeg', title: 'Donation', subtitle: 'Day', category: 's-c' },
            { src: '/assets/gallery-img/SC (11).jpeg', title: 'Donation', subtitle: 'Day', category: 's-c' },
            { src: '/assets/gallery-img/SC (12).jpeg', title: 'Donation', subtitle: 'Day', category: 's-c' },
            { src: '/assets/gallery-img/W.jpeg', title: 'Story', subtitle: 'Writing', category: 'w-w' },
            { src: '/assets/gallery-img/W (2).jpeg', title: 'Dialogue', subtitle: 'Writing', category: 'w-w' },
            { src: '/assets/gallery-img/W (3).jpeg', title: 'Dialogue', subtitle: 'Writing', category: 'w-w' },
            { src: '/assets/gallery-img/W (4).jpeg', title: 'Picture Description', subtitle: 'Writing', category: 'w-w' },
        ];

        class ModernGallery {
            constructor() {
                this.galleryGrid = document.getElementById('galleryGrid');
                this.filterButtons = document.querySelectorAll('.filter-btn');
                this.currentFilter = 'all';
                this.intersectionObserver = null;
                this.msnry = null; // Masonry instance
                this.itemSelector = '.gallery-item-wrapper'; // Selector for masonry items

                this.init();
            }

            init() {
                this.setupIntersectionObserver();
                this.setupEventListeners();
                this.addBackButtonListener(); // Add listener for the go back button
                this.renderGallery();

                // Initialize Masonry after initial rendering and images are loaded
                // imagesLoaded ensures Masonry calculates heights correctly after all images are loaded
                imagesLoaded(this.galleryGrid, () => {
                    this.msnry = new Masonry(this.galleryGrid, {
                        itemSelector: this.itemSelector,
                        columnWidth: this.itemSelector, // Use item width for column calculation
                        gutter: parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')), // Get gap from CSS variable
                        percentPosition: true, // Crucial for responsive column widths
                        transitionDuration: '0.4s'
                    });

                    // Re-layout Masonry when an individual image loads *after* initial setup
                    // This handles lazy-loaded images updating their size
                    this.galleryGrid.querySelectorAll('img').forEach(img => {
                        if (!img.complete) {
                            img.onload = () => {
                                if (this.msnry) {
                                    this.msnry.layout();
                                }
                            };
                        }
                    });

                    // Re-layout on window resize (debounced)
                    window.addEventListener('resize', this.debounce(() => {
                        if (this.msnry) {
                            this.msnry.layout();
                        }
                    }, 200));

                    // Remove loading indicator once masonry is laid out
                    const loadingIndicator = this.galleryGrid.querySelector('.loading');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                });
            }

            // Utility to debounce functions
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Sets up the Intersection Observer for lazy loading images
            setupIntersectionObserver() {
                this.intersectionObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src; // Set the actual image source
                                img.removeAttribute('data-src');
                                observer.unobserve(img); // Stop observing once loaded
                            }
                        }
                    });
                }, {
                    rootMargin: '100px 0px', // Start loading 100px before entering viewport
                    threshold: 0.01 // Trigger when even a small part is visible
                });
            }

            // Sets up click listeners for filter buttons
            setupEventListeners() {
                this.filterButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const filter = btn.dataset.filter;
                        this.filterGallery(filter);
                        this.updateActiveButton(btn);
                    });
                });
            }

            // Handles the "Go Back" button click
            addBackButtonListener() {
                const backButton = document.querySelector('.backbtn');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        window.history.back(); // Navigates back in browser history
                    });
                }
            }

            // Determines image orientation based on natural dimensions
            // This is primarily for CSS styling (e.g., aspect-ratio overrides)
            getImageOrientation(width, height) {
                if (width === 0 || height === 0) return 'square'; // Fallback for 0 dimensions
                const ratio = width / height;

                if (ratio > 2.0) return 'wide-landscape';
                if (ratio > 1.3) return 'landscape';
                if (ratio > 0.9 && ratio < 1.1) return 'square';
                if (ratio < 0.6) return 'tall-portrait'; // More extreme portrait
                return 'portrait'; // Default portrait
            }

            // Creates a single gallery item DOM element
            createGalleryItem(item) {
                const wrapper = document.createElement('div');
                wrapper.className = 'gallery-item-wrapper';
                wrapper.dataset.category = item.category;

                const img = document.createElement('img');
                img.alt = item.title;
                img.dataset.src = item.src; // Initial source for lazy loading
                // Placeholder SVG to prevent empty space and layout shifts before image loads
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PC9zdmc+';

                // Add onload listener to the actual image to update orientation class if needed
                img.onload = () => {
                    const orientation = this.getImageOrientation(img.naturalWidth, img.naturalHeight);
                    if (!wrapper.classList.contains(orientation)) {
                        wrapper.classList.add(orientation); // Add orientation class after knowing actual dimensions
                    }
                    // Trigger Masonry layout if it's already initialized
                    if (this.msnry) {
                        this.msnry.layout();
                    }
                };

                img.onerror = () => {
                    console.error(`Failed to load image: ${item.src}`);
                    wrapper.remove(); // Remove item if image fails to load
                    if (this.msnry) {
                        this.msnry.layout(); // Re-layout the remaining items
                    }
                };

                const overlay = document.createElement('div');
                overlay.className = 'gallery-item-overlay';
                const overlayContent = document.createElement('div');
                overlayContent.className = 'overlay-content';
                const title = document.createElement('h3');
                title.className = 'overlay-title';
                title.textContent = item.title;
                const subtitle = document.createElement('p');
                subtitle.className = 'overlay-subtitle';
                subtitle.textContent = item.subtitle;
                const icon = document.createElement('svg');
                icon.className = 'overlay-icon';
                icon.setAttribute('viewBox', '0 0 24 24');
                icon.innerHTML = '<path d="M12 2L1 7L12 12L23 7L12 2Z"/><path d="M1 17L12 22L23 17"/><path d="M1 12L12 17L23 12"/>';

                overlayContent.appendChild(title);
                overlayContent.appendChild(subtitle);
                overlayContent.appendChild(icon);
                overlay.appendChild(overlayContent);

                wrapper.appendChild(img);
                wrapper.appendChild(overlay);

                // Add to IntersectionObserver for lazy loading
                this.intersectionObserver.observe(img);

                return wrapper;
            }

            // Renders all gallery items initially
            renderGallery() {
                this.galleryGrid.innerHTML = '<div class="loading">Loading gallery...</div>'; // Keep loading message for Masonry

                // Use a document fragment for efficient DOM manipulation
                const fragment = document.createDocumentFragment();

                galleryItems.forEach(item => {
                    const galleryItem = this.createGalleryItem(item);
                    fragment.appendChild(galleryItem);
                });

                // Append all items at once to the grid
                this.galleryGrid.appendChild(fragment);

                // Masonry will be initialized by imagesLoaded in init()
            }

            // Filters gallery items based on category
            filterGallery(category) {
                this.currentFilter = category;

                const items = Array.from(this.galleryGrid.querySelectorAll(this.itemSelector));

                items.forEach((item) => {
                    const itemCategory = item.dataset.category;
                    const shouldShow = category === 'all' || itemCategory === category;

                    if (shouldShow) {
                        item.style.display = 'block'; // Make visible for Masonry to include in layout
                        item.classList.remove('hiding');
                        item.classList.add('showing');
                    } else {
                        item.style.display = 'none'; // Hide from Masonry layout
                        item.classList.remove('showing');
                        item.classList.add('hiding');
                    }
                });

                // Tell Masonry to re-layout the grid after items' display property has changed
                if (this.msnry) {
                    this.msnry.layout();
                }
            }

            // Updates the active state of filter buttons
            updateActiveButton(activeBtn) {
                this.filterButtons.forEach(btn => btn.classList.remove('active'));
                activeBtn.classList.add('active');
            }

            // Adds a new image dynamically
            addNewImage(src, title, subtitle, category) {
                const newItemData = { src, title, subtitle, category };
                galleryItems.push(newItemData); // Add to data array

                const newGalleryItem = this.createGalleryItem(newItemData); // Create DOM element

                // Append new item to the grid
                this.galleryGrid.appendChild(newGalleryItem);

                // Tell Masonry to add and layout the new item(s)
                // imagesLoaded ensures the item is added only after its image content loads
                imagesLoaded(newGalleryItem, () => {
                    if (this.msnry) {
                        this.msnry.appended(newGalleryItem); // Add to Masonry layout
                    }
                });

                // Apply current filter to the new item immediately
                if (this.currentFilter !== 'all' && category !== this.currentFilter) {
                    newGalleryItem.style.display = 'none'; // Hide if it doesn't match current filter
                }

                return newGalleryItem;
            }

            // Clears the gallery
            clearGallery() {
                galleryItems = [];
                if (this.msnry) {
                    this.msnry.remove(Array.from(this.galleryGrid.children)); // Remove all items from Masonry
                    this.msnry.layout(); // Re-layout after removal
                }
                this.galleryGrid.innerHTML = '<div class="loading">Gallery cleared...</div>';
            }
        }

        // Initialize gallery when DOM is fully loaded
        let gallery;
        document.addEventListener('DOMContentLoaded', () => {
            gallery = new ModernGallery();

            // Example of adding new image programmatically (uncomment to test)
            // setTimeout(() => {
            //     gallery.addNewImage(
            //         'https://images.unsplash.com/photo-1557804506-669a67965ba0?w=800&h=600&fit=crop',
            //         'New Addition',
            //         'Dynamically added artwork',
            //         'digital-art'
            //     );
            // }, 3000);
        });

        // Global function for easy image addition (if needed from outside)
        function addNewImage(src, title, subtitle, category) {
            if (gallery) {
                return gallery.addNewImage(src, title, subtitle, category);
            } else {
                console.warn('Gallery not initialized yet. Call this after DOMContentLoaded.');
                return null;
            }
        }

        // Performance monitoring (development only)
        if (typeof performance !== 'undefined' && performance.mark) {
            performance.mark('gallery-start');
            window.addEventListener('load', () => {
                performance.mark('gallery-end');
                performance.measure('gallery-load-time', 'gallery-start', 'gallery-end');
                const measure = performance.getEntriesByName('gallery-load-time')[0];
                console.log(`Gallery loaded in ${measure.duration.toFixed(2)}ms`);
            });
        }
    </script>
</body>
</html>
